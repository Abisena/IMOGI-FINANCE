# Quick Fix: ER-2026-000027 Budget Control Entry

## âš ï¸ Masalah
Budget Control Entry tidak terbuat untuk ER-2026-000027 yang sudah Approved.

**Root Cause:** ER ini di-approve SEBELUM fix di-deploy, jadi hook belum jalan.

## âœ… Solusi Cepat

### Option 1: Via Browser Console (RECOMMENDED)

1. **Buka ER-2026-000027** di browser
2. **Buka Console** (F12 atau Cmd+Option+I)
3. **Paste script** ini:

```javascript
// Load debug commands
fetch('/assets/imogi_finance/js/budget_control_debug.js')
  .then(r => r.text())
  .then(code => eval(code))
  .then(() => {
    // Run full debug
    debug_budget_control();
    
    // Wait 2 seconds, then trigger
    setTimeout(() => {
      console.log('\nğŸš€ TRIGGERING RESERVE BUDGET...\n');
      trigger_reserve_budget();
    }, 2000);
  });
```

**Atau langsung:**
```javascript
frappe.call({
    method: 'imogi_finance.budget_control.workflow.reserve_budget_for_request_api',
    args: { expense_request: 'ER-2026-000027' },
    freeze: true,
    callback: function(r) {
        if (r.message && r.message.length > 0) {
            console.log('âœ… Created:', r.message);
            frappe.msgprint('Budget Control Entries created: ' + r.message.join(', '));
            cur_frm.reload_doc();
        } else {
            console.log('âš ï¸ No entries created');
        }
    }
});
```

### Option 2: Via Python Console

```bash
bench --site itb-dev.j.frappe.cloud console
```

```python
import frappe
from imogi_finance.budget_control import workflow

# Load document
doc = frappe.get_doc("Expense Request", "ER-2026-000027")

# Trigger reserve budget
entries = workflow.reserve_budget_for_request(doc)

# Check result
print(f"Created entries: {entries}")

# Verify
bce = frappe.get_all(
    "Budget Control Entry",
    filters={"ref_doctype": "Expense Request", "ref_name": "ER-2026-000027"},
    fields=["name", "entry_type", "amount", "docstatus"]
)
print("Budget Control Entries:")
for e in bce:
    print(f"  - {e.name}: {e.entry_type} {e.amount}")

frappe.db.commit()
```

### Option 3: Via Test Script

```bash
bench --site itb-dev.j.frappe.cloud console
```

```python
exec(open('test_budget_control.py').read())
test_budget_control_entry_creation("ER-2026-000027")
```

## ğŸ” Verifikasi

Setelah run salah satu option di atas:

### 1. Check Budget Control Entry List
- Buka: **Budget Control Entry** list
- Filter: ref_doctype = "Expense Request", ref_name = "ER-2026-000027"
- Harus ada entry dengan:
  - Entry Type: RESERVATION
  - Direction: OUT
  - Amount: sesuai ER
  - Docstatus: 1 (Submitted)

### 2. Check ER Document
- Reload ER-2026-000027
- Check fields:
  - Budget Lock Status: **"Locked"** (sebelumnya "Not Locked")
  - Budget Workflow State: **"Approved"** (sebelumnya "Submitted")

### 3. Check via Console
```javascript
// Di browser console
check_bce_exists("ER-2026-000027")
```

Expected output:
```
=== Budget Control Entries ===
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ (index) â”‚      name       â”‚ entry_type  â”‚  amount  â”‚directionâ”‚posting_date  â”‚ docstatus â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    0    â”‚ 'BCE-2026-XXXX' â”‚'RESERVATION'â”‚ 200000   â”‚  'OUT'  â”‚ '2026-01-16' â”‚     1     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš¨ Troubleshooting

### Error: "Budget lock is disabled"
```javascript
// Check settings
check_budget_settings()
```
- Pastikan `enable_budget_lock` = 1
- Jika 0, aktifkan di Budget Control Settings

### Error: "Document status is not Approved"
```javascript
check_budget_dimensions()
```
- Pastikan Status = "Approved"
- Pastikan Workflow State = "Approved"

### Error: "No items with expense accounts"
```javascript
check_budget_dimensions()
```
- Check section "Items"
- Pastikan ada expense_account

### Error: "Fiscal year not found"
- Set Fiscal Year di System Settings
- Atau di User Defaults

### Error: "Insufficient budget"
```javascript
check_budget_exists()
```
- Check apakah Budget document exists
- Check allocated amount vs available

### No entries created, no error
Check logs:
```bash
tail -f ~/frappe-bench/logs/itb-dev.j.frappe.cloud.log | grep -i budget
```

## ğŸ“ Notes

- ER-2026-000027 sudah Approved sebelum fix di-deploy
- Hook `handle_budget_workflow` tidak jalan karena ER sudah di-approve
- Manual trigger diperlukan untuk ER yang sudah Approved
- ER baru setelah fix akan otomatis create Budget Control Entry

## ğŸ¯ Expected Result

Setelah manual trigger:
```
âœ… Budget Control Entry created: BCE-2026-XXXX
âœ… ER budget_lock_status updated: "Locked"
âœ… ER budget_workflow_state updated: "Approved"
```

## â­ï¸ Next Steps

1. âœ… Fix ER-2026-000027 via manual trigger
2. âœ… Verify Budget Control Entry created
3. âœ… Test dengan ER baru â†’ harus otomatis
4. âœ… Monitor logs untuk error
5. âœ… Check all approved ERs: `check_all_approved_ers()`
6. âœ… Fix missing entries: `fix_missing_budget_entries()`

---

**Last Updated:** 2026-01-16
**Status:** Ready to execute
