{% set company_logo = frappe.db.get_value("Company", doc.company, "company_logo") if doc.company else None %}
{% set grouped_items = doc.get_grouped_items() %}
<style>
  .ta-container { font-size: 8pt; font-family: Arial, sans-serif; }
  .ta-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .ta-header .title { font-size: 14pt; font-weight: bold; letter-spacing: 0.5px; }
  .ta-logo { max-height: 50px; max-width: 150px; object-fit: contain; }
  .ta-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
  .ta-table th, .ta-table td { border: 1px solid #999; padding: 4px 6px; vertical-align: top; }
  .ta-table th { background: #e8e8e8; text-align: left; font-weight: bold; }
  .ta-meta { margin-bottom: 8px; line-height: 1.4; }
  .ta-meta div { margin-bottom: 2px; }
  .beneficiary-group { margin-bottom: 12px; border: 2px solid #666; padding: 8px; }
  .beneficiary-header { background: #f0f0f0; padding: 6px; margin: -8px -8px 8px -8px; border-bottom: 2px solid #666; }
  .beneficiary-header h3 { margin: 0 0 4px 0; font-size: 11pt; }
  .beneficiary-info { display: flex; gap: 20px; font-size: 8pt; }
  .beneficiary-info > div { flex: 1; }
  .item-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  .item-table th, .item-table td { border: 1px solid #ccc; padding: 4px; }
  .item-table th { background: #f7f7f7; font-weight: bold; }
  .item-total { background: #fff3cd; font-weight: bold; }
  .grand-total { background: #d4edda; font-weight: bold; font-size: 9pt; }
  .ta-signature { display: flex; justify-content: space-around; margin-top: 15px; gap: 15px; page-break-inside: avoid; }
  .ta-signature .slot { width: 45%; text-align: center; }
  .ta-signature .label { font-weight: bold; margin-bottom: 30px; }
  .ta-signature .line { border-top: 1px solid #333; margin: 0 15px; padding-top: 3px; }
  @media print {
    @page { margin: 12mm 10mm; }
    .beneficiary-group { page-break-inside: avoid; }
  }
</style>

<div class="ta-container">
  <div class="ta-header">
    <div>
      {% if company_logo %}
        <img class="ta-logo" src="{{ company_logo }}">
      {% endif %}
    </div>
    <div style="text-align:right">
      <div class="title">APLIKASI TRANSFER DANA</div>
      <div><strong>No Dokumen:</strong> {{ doc.name }}</div>
      <div><strong>Tanggal:</strong> {{ frappe.utils.format_date(doc.posting_date) }}</div>
      <div><strong>Perusahaan:</strong> {{ doc.company }}</div>
    </div>
  </div>

  <div class="ta-meta">
    <div><strong>Diminta Transfer:</strong> {{ frappe.utils.format_date(doc.requested_transfer_date) }}</div>
    {% if doc.reference_doctype and doc.reference_name %}
      <div><strong>Referensi Utama:</strong> {{ doc.reference_doctype }} - {{ doc.reference_name }}</div>
    {% endif %}
    <div><strong>Metode Transfer:</strong> {{ doc.transfer_method or "-" }}</div>
    <div><strong>Status:</strong> {{ doc.status or doc.workflow_state }}</div>
    {% if doc.transfer_purpose %}
      <div><strong>Tujuan Transfer:</strong> {{ doc.transfer_purpose }}</div>
    {% endif %}
  </div>

  {% if grouped_items %}
    {% for group in grouped_items %}
    <div class="beneficiary-group">
      <div class="beneficiary-header">
        <h3>{% if grouped_items|length > 1 %}Beneficiary {{ loop.index }} - {% endif %}{{ group.beneficiary_name }}</h3>
        <div class="beneficiary-info">
          <div>
            <strong>Bank:</strong> {{ group.bank_name }}{% if group.bank_branch %} (Cabang: {{ group.bank_branch }}){% endif %}<br>
            <strong>No Rekening:</strong> {{ group.account_number }}<br>
            {% if group.account_holder_name %}
            <strong>Atas Nama:</strong> {{ group.account_holder_name }}
            {% endif %}
          </div>
          <div>
            {% if group.party_type and group.party %}
            <strong>Party:</strong> {{ group.party_type }} - {{ group.party }}<br>
            {% endif %}
            <strong>Total Transfer:</strong> {{ frappe.utils.fmt_money(group.total_amount, currency=doc.currency) }}
          </div>
        </div>
      </div>

      <table class="item-table">
        <thead>
          <tr>
            <th style="width:8%">No</th>
            <th style="width:52%">Deskripsi</th>
            <th style="width:20%">Jumlah</th>
            <th style="width:20%">Jumlah Diharapkan</th>
          </tr>
        </thead>
        <tbody>
          {% for item in group.items %}
          <tr>
            <td style="text-align:center">{{ loop.index }}</td>
            <td>
              {{ item.description }}
              {% if item.reference_doctype and item.reference_name %}
                <br><small style="color:#555">(Ref: {{ item.reference_doctype }} {{ item.reference_name }})</small>
              {% endif %}
            </td>
            <td style="text-align:right">{{ frappe.utils.fmt_money(item.amount, currency=doc.currency) }}</td>
            <td style="text-align:right">{{ frappe.utils.fmt_money(item.expected_amount or item.amount, currency=doc.currency) }}</td>
          </tr>
          {% endfor %}
          <tr class="item-total">
            <td colspan="2" style="text-align:right"><strong>Subtotal Beneficiary</strong></td>
            <td style="text-align:right">{{ frappe.utils.fmt_money(group.total_amount, currency=doc.currency) }}</td>
            <td style="text-align:right">{{ frappe.utils.fmt_money(group.total_expected, currency=doc.currency) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    {% endfor %}

    {% if grouped_items|length > 1 %}
    <table class="ta-table">
      <tr class="grand-total">
        <td style="width:60%; text-align:right"><strong>TOTAL KESELURUHAN</strong></td>
        <td style="width:20%; text-align:right">{{ frappe.utils.fmt_money(doc.amount, currency=doc.currency) }}</td>
        <td style="width:20%; text-align:right">{{ frappe.utils.fmt_money(doc.expected_amount, currency=doc.currency) }}</td>
      </tr>
    </table>
    {% endif %}

    <table class="ta-table">
      <tr>
        <th style="width:50%">Ringkasan</th>
        <th style="width:50%">Informasi Tambahan</th>
      </tr>
      <tr>
        <td>
          <div><strong>Total Nilai:</strong> {{ frappe.utils.fmt_money(doc.amount, currency=doc.currency) }}</div>
          <div><strong>Terbilang:</strong> <em>{{ doc.amount_in_words }}</em></div>
          <div><strong>Jumlah Beneficiary:</strong> {{ grouped_items|length }}</div>
          <div><strong>Jumlah Item:</strong> {{ doc.items|length }}</div>
        </td>
        <td>
          {% if doc.bank_reference_hint %}
            <div><strong>Petunjuk Referensi Bank:</strong> {{ doc.bank_reference_hint }}</div>
          {% endif %}
          {% if doc.payment_entry %}
            <div><strong>Payment Entry:</strong> {{ doc.payment_entry }}</div>
          {% endif %}
          {% if doc.paid_date %}
            <div><strong>Tanggal Bayar:</strong> {{ frappe.utils.format_date(doc.paid_date) }}</div>
            <div><strong>Jumlah Dibayar:</strong> {{ frappe.utils.fmt_money(doc.paid_amount, currency=doc.currency) }}</div>
          {% endif %}
        </td>
      </tr>
    </table>

  {% else %}
    <div style="text-align:center; color:#999; padding:30px; border:1px dashed #ccc">
      Belum ada item transfer yang ditambahkan
    </div>
  {% endif %}

  <table class="ta-table" style="margin-top:8px">
    <tr>
      <th>Informasi Dokumen</th>
    </tr>
    <tr>
      <td>
        <div style="display:flex; gap:30px">
          <div style="flex:1">
            <strong>Status Workflow:</strong> {{ doc.workflow_state or '-' }}<br>
            <strong>Dibuat oleh:</strong> {{ doc.created_by_user or frappe.session.user }}<br>
            {% if doc.submit_on %}
            <strong>Disubmit pada:</strong> {{ frappe.utils.format_datetime(doc.submit_on) }}
            {% endif %}
          </div>
          <div style="flex:1">
            {% if doc.printed_by %}
            <strong>Dicetak oleh:</strong> {{ doc.printed_by }}<br>
            <strong>Tanggal Cetak:</strong> {{ frappe.utils.format_datetime(doc.printed_at) }}
            {% else %}
            <strong>Belum dicetak</strong>
            {% endif %}
          </div>
        </div>
      </td>
    </tr>
  </table>

  <div class="ta-signature">
    <div class="slot">
      <div class="label">{{ doc.signatory_1_label or 'Disetujui Oleh' }}</div>
      <div class="line"></div>
      <div><strong>{{ doc.signatory_1_name or '( ............................. )' }}</strong></div>
      <div style="color:#666">{{ doc.signatory_1_title or '&nbsp;' }}</div>
    </div>
    <div class="slot">
      <div class="label">{{ doc.signatory_2_label or 'Disetujui Oleh' }}</div>
      <div class="line"></div>
      <div><strong>{{ doc.signatory_2_name or '( ............................. )' }}</strong></div>
      <div style="color:#666">{{ doc.signatory_2_title or '&nbsp;' }}</div>
    </div>
  </div>
</div>
