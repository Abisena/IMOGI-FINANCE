<style>
  :root {
    --primary:      #1a1a2e;
    --accent:       #16213e;
    --border:       #e2e8f0;
    --border-dark:  #cbd5e0;
    --bg-light:     #f8fafc;
    --bg-header:    #eef2ff;
    --text:         #1e293b;
    --text-muted:   #64748b;
    --text-light:   #94a3b8;
    --green:        #166534;
    --green-bg:     #dcfce7;
    --amber:        #92400e;
    --amber-bg:     #fef3c7;
    --red:          #991b1b;
    --red-bg:       #fee2e2;
    --blue:         #1e40af;
    --blue-bg:      #dbeafe;
  }

  * {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-size: 10.5pt;
    color: var(--text);
    line-height: 1.45;
  }

  /* CONTAINER */
  .er-wrap { width: 100%; background: white; }

  /* HEADER */
  .er-header {
    display: table; width: 100%;
    border-bottom: 2.5pt solid var(--primary);
    padding-bottom: 10pt; margin-bottom: 14pt;
  }
  .er-header-left  { display: table-cell; vertical-align: middle; }
  .er-header-right { display: table-cell; vertical-align: middle; text-align: right; }
  .er-title  { font-size: 17pt; font-weight: 700; color: var(--primary); letter-spacing: -0.3pt; margin-bottom: 2pt; }
  .er-docid  { font-size: 9pt; color: var(--text-muted); letter-spacing: 0.3pt; }

  /* STATUS BADGES */
  .badge { display: inline-block; padding: 4pt 12pt; font-size: 8pt; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6pt; border-radius: 3pt; }
  .badge-approved { background: var(--primary); color: white; }
  .badge-pending  { background: var(--amber-bg); color: var(--amber); border: 1pt solid #fde68a; }
  .badge-rejected { background: var(--red-bg);   color: var(--red);   border: 1pt solid #fecaca; }
  .badge-default  { background: var(--bg-light);  color: var(--text-muted); border: 1pt solid var(--border); }

  /* LABELS */
  .section-label {
    font-size: 7.5pt; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8pt;
    color: var(--text-muted); margin: 0 0 6pt 0; padding-bottom: 4pt; border-bottom: 1pt solid var(--border);
  }

  /* INFO CARDS */
  .info-grid { display: table; width: 100%; margin-bottom: 12pt; }
  .info-grid-cell { display: table-cell; width: 50%; vertical-align: top; }
  .info-grid-cell:first-child { padding-right: 6pt; }
  .info-grid-cell:last-child  { padding-left:  6pt; }
  .card { background: white; border: 1pt solid var(--border); border-radius: 5pt; padding: 10pt 12pt; height: 100%; }
  .card-header-accent { border-top: 3pt solid var(--primary); }
  .info-row { display: table; width: 100%; padding: 2.5pt 0; font-size: 9.5pt; }
  .info-label { display: table-cell; width: 42%; color: var(--text-muted); vertical-align: top; }
  .info-value { display: table-cell; font-weight: 600; color: var(--text); text-align: right; vertical-align: top; }
  .info-divider { border: none; border-top: 1pt solid var(--border); margin: 6pt 0; }

  /* NOTES */
  .notes { background: var(--bg-light); border-left: 3pt solid var(--primary); padding: 7pt 11pt; margin-bottom: 12pt; border-radius: 0 4pt 4pt 0; }
  .notes-label { font-size: 7.5pt; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 3pt; }
  .notes-text  { font-size: 9.5pt; color: var(--text); line-height: 1.5; }

  /* TAX INVOICE NOTICE */
  .tax-notice { display: table; width: 100%; background: var(--blue-bg); border: 1pt solid #bfdbfe; border-radius: 4pt; padding: 7pt 11pt; margin-bottom: 12pt; font-size: 9pt; }
  .tax-notice-left  { display: table-cell; width: 60%; }
  .tax-notice-right { display: table-cell; width: 40%; text-align: right; }
  .tax-notice-label { font-size: 7.5pt; font-weight: 700; text-transform: uppercase; color: var(--blue); margin-bottom: 2pt; }
  .tax-notice-val   { font-weight: 600; color: var(--primary); }

  /* ITEMS TABLE */
  .items-section-label {
    font-size: 9pt; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5pt;
    color: var(--primary); margin-bottom: 6pt; padding-bottom: 4pt; border-bottom: 2pt solid var(--primary);
  }
  .items-table { width: 100%; border-collapse: collapse; font-size: 9.5pt; }
  .items-table thead tr { background: var(--primary); }
  .items-table thead th { padding: 7pt 9pt; font-size: 8pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3pt; color: white; text-align: left; }
  .items-table thead th.num   { text-align: center; }
  .items-table thead th.right { text-align: right; }
  .items-table tbody td { padding: 7pt 9pt; border-bottom: 1pt solid var(--border); color: var(--text); vertical-align: top; }
  .items-table tbody td.num   { text-align: center; color: var(--text-muted); }
  .items-table tbody td.right { text-align: right; font-weight: 500; }
  .items-table tbody td.meta  { font-size: 8.5pt; color: var(--text-muted); }
  .items-table tbody tr:nth-child(even) { background: var(--bg-light); }
  .items-table tfoot tr:first-child td { border-top: 2pt solid var(--primary); }
  .items-table tfoot td { padding: 6pt 9pt; font-size: 9pt; background: var(--bg-light); }
  .items-table tfoot td.right { text-align: right; font-weight: 600; color: var(--primary); }

  /* FINANCIAL SUMMARY */
  .fin-summary { width: 55%; margin-left: auto; margin-top: 0; margin-bottom: 12pt; border: 1pt solid var(--border); border-radius: 5pt; overflow: hidden; }
  .fin-row { display: table; width: 100%; }
  .fin-label { display: table-cell; padding: 5pt 11pt; font-size: 9.5pt; color: var(--text-muted); width: 55%; }
  .fin-value { display: table-cell; padding: 5pt 11pt; font-size: 9.5pt; font-weight: 600; text-align: right; color: var(--text); }
  .fin-row.separator .fin-label,
  .fin-row.separator .fin-value { border-top: 1pt solid var(--border); }
  .fin-row.total-row .fin-label,
  .fin-row.total-row .fin-value { background: var(--primary); color: white; font-size: 11pt; padding: 8pt 11pt; }
  .fin-row.deduction .fin-value { color: var(--red); }

  /* SIGNATURE */
  .sig-section { margin-top: 22pt; page-break-inside: avoid; }
  .sig-section-label {
    font-size: 9pt; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5pt;
    color: var(--primary); margin-bottom: 12pt; padding-bottom: 4pt; border-bottom: 2pt solid var(--primary);
  }
  .sig-table { width: 100%; border-collapse: separate; border-spacing: 8pt 0; }
  .sig-table td { width: 25%; vertical-align: top; padding: 0; }
  .sig-box { border: 1pt solid var(--border); border-radius: 5pt; padding: 9pt 8pt; background: white; text-align: center; }
  .sig-box.approved-box { border-color: #86efac; background: #f0fdf4; }
  .sig-box.pending-box  { border-color: #fde68a; background: #fffbeb; }
  .sig-role  { font-size: 7.5pt; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4pt; color: var(--text-muted); margin-bottom: 5pt; }
  .sig-area  { height: 42pt; margin: 0 4pt; border-bottom: 1pt solid var(--primary); }
  .sig-name  { font-size: 8.5pt; font-weight: 600; color: var(--primary); margin-top: 5pt; min-height: 11pt; }
  .sig-date  { font-size: 7.5pt; color: var(--text-muted); margin-top: 2pt; min-height: 9pt; }
  .sig-stamp { font-size: 7pt; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3pt; margin-top: 4pt; padding: 2pt 7pt; border-radius: 2pt; display: inline-block; }
  .sig-stamp.approved { background: var(--green-bg); color: var(--green); }
  .sig-stamp.pending  { background: var(--amber-bg); color: var(--amber); }

  /* FOOTER */
  .er-footer { margin-top: 24pt; padding-top: 8pt; border-top: 1pt solid var(--border); text-align: center; }
  .er-footer p { font-size: 7.5pt; color: var(--text-light); line-height: 1.7; font-style: italic; }

  /* PRINT */
  @media print {
    @page { size: A4 portrait; margin: 14mm 12mm; }
    body { font-size: 10pt; }
    .items-table thead tr,
    .fin-row.total-row .fin-label,
    .fin-row.total-row .fin-value,
    .badge-approved {
      background: var(--primary) !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .sig-box.approved-box { background: #f0fdf4 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .sig-box.pending-box  { background: #fffbeb !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .sig-stamp.approved   { background: var(--green-bg) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .sig-stamp.pending    { background: var(--amber-bg) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .tax-notice           { background: var(--blue-bg) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .sig-section          { page-break-inside: avoid; }
    .fin-summary          { page-break-inside: avoid; }
  }
</style>

{%- set status = doc.status or doc.workflow_state or 'Draft' -%}
{%- set status_classes = {
    'Approved':    'badge-approved',
    'Paid':        'badge-approved',
    'Completed':   'badge-approved',
    'Pending Review': 'badge-pending',
    'Under Review':   'badge-pending',
    'Draft':       'badge-default',
    'Rejected':    'badge-rejected',
    'Cancelled':   'badge-rejected'
} -%}
{%- set badge_cls = status_classes.get(status, 'badge-default') -%}

<div class="er-wrap">

  <!-- HEADER -->
  <div class="er-header">
    <div class="er-header-left">
      <div class="er-title">{{ _("Expense Request") }}</div>
      <div class="er-docid">{{ doc.name }} &nbsp;&middot;&nbsp; {{ frappe.utils.formatdate(doc.request_date, "dd MMMM yyyy") }}</div>
    </div>
    <div class="er-header-right">
      <span class="badge {{ badge_cls }}">{{ status }}</span>
    </div>
  </div>

  <!-- INFO CARDS -->
  <div class="info-grid">
    <div class="info-grid-cell">
      <div class="card card-header-accent">
        <div class="section-label">{{ _("Detail Permintaan") }}</div>
        <div class="info-row">
          <span class="info-label">{{ _("Tanggal") }}</span>
          <span class="info-value">{{ frappe.utils.formatdate(doc.request_date, "dd MMM yyyy") }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">{{ _("Jenis") }}</span>
          <span class="info-value">{{ doc.request_type }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">{{ _("Cost Center") }}</span>
          <span class="info-value">{{ doc.cost_center }}</span>
        </div>
        {%- if doc.branch %}
        <div class="info-row">
          <span class="info-label">{{ _("Cabang") }}</span>
          <span class="info-value">{{ doc.branch }}</span>
        </div>
        {%- endif %}
        {%- if doc.project %}
        <div class="info-row">
          <span class="info-label">{{ _("Proyek") }}</span>
          <span class="info-value">{{ doc.project }}</span>
        </div>
        {%- endif %}
        {%- if doc.allocation_mode and doc.allocation_mode != "Direct" %}
        <div class="info-row">
          <span class="info-label">{{ _("Mode Alokasi") }}</span>
          <span class="info-value">{{ doc.allocation_mode }}</span>
        </div>
        {%- endif %}
        <hr class="info-divider">
        <div class="info-row">
          <span class="info-label">{{ _("Mata Uang") }}</span>
          <span class="info-value">{{ doc.currency }}</span>
        </div>
        {%- if doc.linked_payment_entry %}
        <div class="info-row">
          <span class="info-label">{{ _("Payment Entry") }}</span>
          <span class="info-value">{{ doc.linked_payment_entry }}</span>
        </div>
        {%- else %}
        <div class="info-row">
          <span class="info-label">{{ _("Status Bayar") }}</span>
          <span class="info-value">{{ doc.status }}</span>
        </div>
        {%- endif %}
      </div>
    </div>

    <div class="info-grid-cell">
      <div class="card card-header-accent">
        <div class="section-label">{{ _("Informasi Supplier") }}</div>
        <div class="info-row">
          <span class="info-label">{{ _("Nama Supplier") }}</span>
          <span class="info-value">{{ doc.supplier }}</span>
        </div>
        {%- if doc.supplier_tax_id %}
        <div class="info-row">
          <span class="info-label">{{ _("NPWP Supplier") }}</span>
          <span class="info-value" style="font-family: monospace; font-size: 9pt;">{{ doc.supplier_tax_id }}</span>
        </div>
        {%- endif %}
        <hr class="info-divider">
        {%- if doc.supplier_invoice_no %}
        <div class="info-row">
          <span class="info-label">{{ _("No. Invoice") }}</span>
          <span class="info-value">{{ doc.supplier_invoice_no }}</span>
        </div>
        {%- endif %}
        {%- if doc.supplier_invoice_date %}
        <div class="info-row">
          <span class="info-label">{{ _("Tgl. Invoice") }}</span>
          <span class="info-value">{{ frappe.utils.formatdate(doc.supplier_invoice_date, "dd MMM yyyy") }}</span>
        </div>
        {%- endif %}
        <hr class="info-divider">
        <div class="info-row">
          <span class="info-label">{{ _("Kena PPN") }}</span>
          <span class="info-value">{{ "Ya" if doc.is_ppn_applicable else "Tidak" }}</span>
        </div>
        {%- if doc.is_ppn_applicable and doc.ppn_template %}
        <div class="info-row">
          <span class="info-label">{{ _("Template PPN") }}</span>
          <span class="info-value">{{ doc.ppn_template }}</span>
        </div>
        {%- endif %}
        <div class="info-row">
          <span class="info-label">{{ _("Kena PPh") }}</span>
          <span class="info-value">{{ ("Ya — " ~ doc.pph_type) if (doc.is_pph_applicable and doc.pph_type) else ("Ya" if doc.is_pph_applicable else "Tidak") }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- TAX INVOICE NOTICE -->
  {%- if doc.is_ppn_applicable and (doc.ti_fp_no or doc.tax_invoice_number) %}
  {%- set fp_no   = doc.ti_fp_no or doc.tax_invoice_number %}
  {%- set fp_date = doc.ti_fp_date or doc.tax_invoice_date %}
  <div class="tax-notice">
    <div class="tax-notice-left">
      <div class="tax-notice-label">{{ _("Faktur Pajak") }}{{ " — hasil OCR" if doc.ti_fp_no else "" }}</div>
      <div class="tax-notice-val">No. {{ fp_no }}</div>
    </div>
    <div class="tax-notice-right">
      {%- if fp_date %}
      <div class="tax-notice-label">{{ _("Tanggal FP") }}</div>
      <div class="tax-notice-val">{{ frappe.utils.formatdate(fp_date, "dd MMM yyyy") }}</div>
      {%- endif %}
    </div>
  </div>
  {%- endif %}

  <!-- NOTES -->
  {%- if doc.description %}
  <div class="notes">
    <div class="notes-label">{{ _("Catatan") }}</div>
    <div class="notes-text">{{ doc.description }}</div>
  </div>
  {%- endif %}

  <!-- ITEMS TABLE -->
  <div class="items-section-label">{{ _("Rincian Biaya") }}</div>
  <table class="items-table">
    <thead>
      <tr>
        <th class="num"   style="width:4%">#</th>
        <th               style="width:35%">{{ _("Akun / Keterangan") }}</th>
        <th               style="width:21%">{{ _("Cost Center") }}</th>
        <th class="right" style="width:20%">{{ _("Jumlah (DPP)") }}</th>
        <th class="right" style="width:20%">{{ _("Dasar PPh") }}</th>
      </tr>
    </thead>
    <tbody>
      {%- for row in doc.items %}
      <tr>
        <td class="num">{{ loop.index }}</td>
        <td>
          <div style="font-weight:600; color:var(--primary)">{{ row.expense_account }}</div>
          {%- if row.description %}<div class="meta">{{ row.description }}</div>{%- endif %}
        </td>
        <td class="meta">{{ row.cost_center or '—' }}</td>
        <td class="right">{{ frappe.utils.fmt_money(row.amount, currency=doc.currency) }}</td>
        <td class="right">
          {%- if row.is_pph_applicable and row.pph_base_amount %}
          {{ frappe.utils.fmt_money(row.pph_base_amount, currency=doc.currency) }}
          {%- else %}
          <span style="color:var(--text-light)">—</span>
          {%- endif %}
        </td>
      </tr>
      {%- endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="3" style="text-align:right; color:var(--text-muted); font-size:9pt;">{{ _("Subtotal (DPP)") }}</td>
        <td class="right" colspan="2">{{ frappe.utils.fmt_money(doc.amount, currency=doc.currency) }}</td>
      </tr>
    </tfoot>
  </table>

  <!-- FINANCIAL SUMMARY -->
  <div class="fin-summary">
    <div class="fin-row">
      <span class="fin-label">{{ _("Subtotal (DPP)") }}</span>
      <span class="fin-value">{{ frappe.utils.fmt_money(doc.amount or 0, currency=doc.currency) }}</span>
    </div>
    {%- if doc.total_ppn %}
    <div class="fin-row separator">
      <span class="fin-label">{{ _("PPN") }}{%- if doc.ppn_template %} <span style="font-size:8pt;color:var(--text-muted)">({{ doc.ppn_template }})</span>{%- endif %}</span>
      <span class="fin-value">{{ frappe.utils.fmt_money(doc.total_ppn, currency=doc.currency) }}</span>
    </div>
    {%- endif %}
    {%- if doc.total_ppnbm %}
    <div class="fin-row separator">
      <span class="fin-label">{{ _("PPnBM") }}</span>
      <span class="fin-value">{{ frappe.utils.fmt_money(doc.total_ppnbm, currency=doc.currency) }}</span>
    </div>
    {%- endif %}
    {%- if doc.total_pph %}
    <div class="fin-row separator deduction">
      <span class="fin-label">{{ _("PPh (dipotong)") }}{%- if doc.pph_type %} <span style="font-size:8pt;color:var(--text-muted)">({{ doc.pph_type }})</span>{%- endif %}</span>
      <span class="fin-value">- {{ frappe.utils.fmt_money(doc.total_pph, currency=doc.currency) }}</span>
    </div>
    {%- endif %}
    {%- if doc.ti_ppn_variance %}
    <div class="fin-row separator">
      <span class="fin-label" style="font-style:italic;font-size:8.5pt;">{{ _("Selisih PPN (OCR)") }}</span>
      <span class="fin-value"  style="font-size:8.5pt;">{{ frappe.utils.fmt_money(doc.ti_ppn_variance, currency=doc.currency) }}</span>
    </div>
    {%- endif %}
    <div class="fin-row total-row">
      <span class="fin-label">{{ _("GRAND TOTAL") }}</span>
      <span class="fin-value">{{ frappe.utils.fmt_money(doc.total_amount or 0, currency=doc.currency) }}</span>
    </div>
  </div>

  <!-- SIGNATURE SECTION -->
  <div class="sig-section">
    <div class="sig-section-label">{{ _("Tanda Tangan &amp; Persetujuan") }}</div>
    <table class="sig-table">
      <tr>
        <td>
          <div class="sig-box">
            <div class="sig-role">{{ _("Dibuat Oleh") }}</div>
            <div class="sig-area"></div>
            <div class="sig-name">{{ doc.owner.split('@')[0] if doc.owner else '' }}</div>
            <div class="sig-date">{{ frappe.utils.formatdate(doc.creation, "dd MMM yyyy") if doc.creation else '' }}</div>
          </div>
        </td>
        {%- if doc.level_1_user %}
        {%- set l1_ok = doc.level_1_approved_on and not doc.level_1_rejected_on %}
        <td>
          <div class="sig-box {{ 'approved-box' if l1_ok else 'pending-box' }}">
            <div class="sig-role">{{ _("Persetujuan L1") }}</div>
            <div class="sig-area"></div>
            <div class="sig-name">{{ doc.level_1_user.split('@')[0] }}</div>
            <div class="sig-date">{{ frappe.utils.formatdate(doc.level_1_approved_on, "dd MMM yyyy") if doc.level_1_approved_on else '' }}</div>
            {%- if l1_ok %}<span class="sig-stamp approved">{{ _("Disetujui") }}</span>
            {%- elif doc.level_1_rejected_on %}<span class="sig-stamp" style="background:var(--red-bg);color:var(--red)">{{ _("Ditolak") }}</span>
            {%- else %}<span class="sig-stamp pending">{{ _("Menunggu") }}</span>{%- endif %}
          </div>
        </td>
        {%- endif %}
        {%- if doc.level_2_user %}
        {%- set l2_ok = doc.level_2_approved_on and not doc.level_2_rejected_on %}
        <td>
          <div class="sig-box {{ 'approved-box' if l2_ok else 'pending-box' }}">
            <div class="sig-role">{{ _("Persetujuan L2") }}</div>
            <div class="sig-area"></div>
            <div class="sig-name">{{ doc.level_2_user.split('@')[0] }}</div>
            <div class="sig-date">{{ frappe.utils.formatdate(doc.level_2_approved_on, "dd MMM yyyy") if doc.level_2_approved_on else '' }}</div>
            {%- if l2_ok %}<span class="sig-stamp approved">{{ _("Disetujui") }}</span>
            {%- elif doc.level_2_rejected_on %}<span class="sig-stamp" style="background:var(--red-bg);color:var(--red)">{{ _("Ditolak") }}</span>
            {%- else %}<span class="sig-stamp pending">{{ _("Menunggu") }}</span>{%- endif %}
          </div>
        </td>
        {%- endif %}
        {%- if doc.level_3_user %}
        {%- set l3_ok = doc.level_3_approved_on and not doc.level_3_rejected_on %}
        <td>
          <div class="sig-box {{ 'approved-box' if l3_ok else 'pending-box' }}">
            <div class="sig-role">{{ _("Persetujuan L3") }}</div>
            <div class="sig-area"></div>
            <div class="sig-name">{{ doc.level_3_user.split('@')[0] }}</div>
            <div class="sig-date">{{ frappe.utils.formatdate(doc.level_3_approved_on, "dd MMM yyyy") if doc.level_3_approved_on else '' }}</div>
            {%- if l3_ok %}<span class="sig-stamp approved">{{ _("Disetujui") }}</span>
            {%- elif doc.level_3_rejected_on %}<span class="sig-stamp" style="background:var(--red-bg);color:var(--red)">{{ _("Ditolak") }}</span>
            {%- else %}<span class="sig-stamp pending">{{ _("Menunggu") }}</span>{%- endif %}
          </div>
        </td>
        {%- endif %}
        {%- if not doc.level_1_user and not doc.level_2_user and not doc.level_3_user %}
        <td><div class="sig-box pending-box"><div class="sig-role">{{ _("Approver") }}</div><div class="sig-area"></div><div class="sig-name"></div><span class="sig-stamp pending">{{ _("Menunggu") }}</span></div></td>
        <td></td>
        <td></td>
        {%- endif %}
      </tr>
    </table>
  </div>

  <!-- FOOTER -->
  <div class="er-footer">
    <p>
      Dokumen ini dibuat melalui modul <strong>IMOGI Finance &mdash; Expense Request</strong><br>
      PT. Inovasi Terbaik Bangsa &nbsp;&middot;&nbsp; {{ frappe.utils.formatdate(frappe.utils.nowdate(), "dd MMMM yyyy") }} {{ frappe.utils.nowtime()[:5] }}
    </p>
  </div>

</div>
