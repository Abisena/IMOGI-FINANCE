{% set bundle = doc.snapshot_data or {} %}
{% set consolidated = bundle.get('consolidated') or {} %}
{% set branches = bundle.get('branches') or [] %}
{% set signers = bundle.get('signers') or {} %}

<style>
  body { font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 9px; }
  .cb-container { max-width: 1000px; margin: 0 auto; padding: 6px 10px; position: relative; }
  .cb-header { text-align: left; margin-bottom: 6px; }
  .cb-title { font-size: 12px; font-weight: 600; text-transform: uppercase; }
  .cb-subtitle { color: #555; font-size: 9px; }
  .cb-type-badge { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 8px; font-weight: 600; margin-left: 8px; }
  .cb-type-badge.bank { background: #e0f2fe; color: #0369a1; }
  .cb-type-badge.cash { background: #dcfce7; color: #15803d; }
  .cb-reprint-badge { 
    display: inline-block; 
    padding: 2px 8px; 
    border-radius: 3px; 
    font-size: 8px; 
    font-weight: 600; 
    margin-left: 8px;
    background: #fef3c7; 
    color: #d97706;
    border: 1px solid #fbbf24;
  }
  .cb-watermark {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    font-size: 72px;
    font-weight: 900;
    color: rgba(251, 191, 36, 0.15);
    z-index: -1;
    pointer-events: none;
    white-space: nowrap;
  }
  .cb-summary-table, .cb-branch-table, .cb-tx-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
  .cb-summary-table th, .cb-summary-table td,
  .cb-branch-table th, .cb-branch-table td,
  .cb-tx-table th, .cb-tx-table td { border: 1px solid #e5e5e5; padding: 3px 5px; font-size: 9px; }
  .cb-summary-table th, .cb-branch-table th, .cb-tx-table th { background: #f5f5f5; text-align: left; text-transform: uppercase; font-size: 8px; }
  .text-right { text-align: right; }
  .cb-branch-section { margin-top: 6px; page-break-inside: avoid; }
  .cb-branch-heading { font-size: 9px; font-weight: 600; margin: 4px 0; }
  .cb-signers { margin-top: 10px; display: flex; justify-content: space-between; font-size: 9px; }
  .cb-signers div { text-align: center; width: 32%; }
  .cb-signers .label { font-weight: 600; margin-bottom: 24px; }
  @media print {
    @page { margin: 10mm 8mm; }
    .cb-container { padding: 6px 10px; }
    .cb-watermark { font-size: 96px; }
  }
</style>

{% if doc.reprint_count and doc.reprint_count > 0 %}
<div class="cb-watermark">REPRINT #{{ doc.reprint_count }}</div>
{% endif %}

<div class="cb-container">
  <div class="cb-header">
    <div class="cb-title">
      Cash / Bank Daily Report
      {% if doc.cash_account %}
        <span class="cb-type-badge cash">CASH LEDGER</span>
      {% elif doc.bank_account %}
        <span class="cb-type-badge bank">BANK TRANSACTION</span>
      {% endif %}
      {% if doc.reprint_count and doc.reprint_count > 0 %}
        <span class="cb-reprint-badge">REPRINT #{{ doc.reprint_count }}</span>
      {% endif %}
    </div>
    <div class="cb-subtitle">
      {{ frappe.utils.format_date(doc.report_date) }}
      {% if doc.branches %}
        · Branches: {{ doc.branches }}
      {% else %}
        · All Branches
      {% endif %}
      {% if doc.bank_account %}
        · Bank Account: {{ doc.bank_account }}
      {% elif doc.cash_account %}
        · Cash Account: {{ doc.cash_account }}
      {% endif %}
      {% if doc.reprint_count and doc.reprint_count > 0 %}
        · Reprint: {{ frappe.utils.format_datetime(doc.last_reprinted_at) }} by {{ doc.last_reprinted_by }}
      {% endif %}
    </div>
  </div>

  <table class="cb-summary-table">
    <thead>
      <tr>
        <th>{{ _("Opening Balance") }}</th>
        <th>{{ _("Inflow") }}</th>
        <th>{{ _("Outflow") }}</th>
        <th>{{ _("Closing Balance") }}</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="text-right">{{ frappe.utils.fmt_money(consolidated.get('opening_balance') or doc.opening_balance or 0) }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(consolidated.get('inflow') or doc.inflow or 0) }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(consolidated.get('outflow') or doc.outflow or 0) }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(consolidated.get('closing_balance') or doc.closing_balance or 0) }}</td>
      </tr>
    </tbody>
  </table>

  <table class="cb-branch-table">
    <thead>
      <tr>
        <th style="width:25%">{{ _("Branch") }}</th>
        <th style="width:18%" class="text-right">{{ _("Opening") }}</th>
        <th style="width:18%" class="text-right">{{ _("Inflow") }}</th>
        <th style="width:18%" class="text-right">{{ _("Outflow") }}</th>
        <th style="width:21%" class="text-right">{{ _("Closing") }}</th>
      </tr>
    </thead>
    <tbody>
      {% for br in branches %}
      <tr>
        <td>{{ br.get('branch') }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(br.get('opening_balance') or 0) }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(br.get('inflow') or 0) }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(br.get('outflow') or 0) }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(br.get('closing_balance') or 0) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {# Detail transaksi per cabang: diambil dari br.transactions yang sudah berisi Bank Transaction #}
  {% for br in branches %}
    {% set txs = br.get('transactions') or [] %}
    {% if txs %}
    <div class="cb-branch-section">
      <div class="cb-branch-heading">{{ _("Branch") }}: {{ br.get('branch') }}</div>
      <table class="cb-tx-table">
        <thead>
          <tr>
            <th style="width:16%">{{ _("Date") }}</th>
            <th style="width:20%">{{ _("Reference") }}</th>
            <th style="width:34%">{{ _("Description") }}</th>
            <th style="width:15%" class="text-right">{{ _("Deposit") }}</th>
            <th style="width:15%" class="text-right">{{ _("Withdrawal") }}</th>
          </tr>
        </thead>
        <tbody>
          {% for tx in txs %}
          <tr>
            <td>{{ frappe.utils.format_date(tx.get('posting_date')) }}</td>
            <td>{{ tx.get('reference') }}</td>
            <td>{{ tx.get('description') or "-" }}</td>
            <td class="text-right">{{ frappe.utils.fmt_money(tx.get('deposit') or 0) }}</td>
            <td class="text-right">{{ frappe.utils.fmt_money(tx.get('withdrawal') or 0) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  {% endfor %}

  {% if signers %}
  <div class="cb-signers">
    <div>
      <div class="label">{{ _("Prepared By") }}</div>
      <div>{{ signers.get('prepared_by') or "" }}</div>
    </div>
    <div>
      <div class="label">{{ _("Approved By") }}</div>
      <div>{{ signers.get('approved_by') or "" }}</div>
    </div>
    <div>
      <div class="label">{{ _("Acknowledged By") }}</div>
      <div>{{ signers.get('acknowledged_by') or "" }}</div>
    </div>
  </div>
  {% endif %}

  {% if doc.created_by_user or doc.submit_on %}
  <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #e5e5e5; font-size: 8px; color: #666;">
    {% if doc.created_by_user %}
    <div><strong>{{ _("Created By") }}:</strong> {{ doc.created_by_user }}</div>
    {% endif %}
    {% if doc.submit_on %}
    <div><strong>{{ _("Submit On") }}:</strong> {{ frappe.utils.format_datetime(doc.submit_on) }}</div>
    {% endif %}
  </div>
  {% endif %}
</div>
