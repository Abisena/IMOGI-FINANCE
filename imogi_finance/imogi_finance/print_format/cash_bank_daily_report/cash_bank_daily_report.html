{% set bundle = doc.snapshot_data or {} %}
{% set consolidated = bundle.get('consolidated') or {} %}
{% set branches = bundle.get('branches') or [] %}
{% set signers = bundle.get('signers') or {} %}

<style>
  body { font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 9px; color: #1f2937; }
  .cb-container { max-width: 1000px; margin: 0 auto; padding: 10px 15px; position: relative; }
  .cb-header { text-align: left; margin-bottom: 12px; border-bottom: 2px solid #3b82f6; padding-bottom: 8px; }
  .cb-title { font-size: 14px; font-weight: 700; text-transform: uppercase; color: #1e40af; margin-bottom: 4px; }
  .cb-subtitle { color: #6b7280; font-size: 9px; line-height: 1.5; }
  .cb-type-badge { display: inline-block; padding: 3px 10px; border-radius: 4px; font-size: 8px; font-weight: 600; margin-left: 8px; }
  .cb-type-badge.bank { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
  .cb-type-badge.cash { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
  .cb-reprint-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 4px;
    font-size: 8px;
    font-weight: 600;
    margin-left: 8px;
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fbbf24;
  }
  .cb-watermark {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    font-size: 72px;
    font-weight: 900;
    color: rgba(251, 191, 36, 0.12);
    z-index: -1;
    pointer-events: none;
    white-space: nowrap;
  }
  .cb-summary-table, .cb-branch-table, .cb-tx-table { width: 100%; border-collapse: collapse; margin-bottom: 12px; }
  .cb-summary-table th, .cb-summary-table td,
  .cb-branch-table th, .cb-branch-table td,
  .cb-tx-table th, .cb-tx-table td { border: 1px solid #e5e7eb; padding: 5px 8px; font-size: 9px; }
  .cb-summary-table th, .cb-branch-table th, .cb-tx-table th {
    background: linear-gradient(to bottom, #f3f4f6, #e5e7eb);
    text-align: left;
    text-transform: uppercase;
    font-size: 8px;
    font-weight: 700;
    color: #374151;
    border-bottom: 2px solid #d1d5db;
  }
  .cb-summary-table tbody tr:hover, .cb-branch-table tbody tr:hover, .cb-tx-table tbody tr:hover {
    background: #f9fafb;
  }
  .text-right { text-align: right; }
  .cb-branch-section {
    margin-top: 12px;
    page-break-inside: avoid;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 8px;
    background: #ffffff;
  }
  .cb-branch-heading {
    font-size: 10px;
    font-weight: 700;
    margin: 0 0 8px 0;
    color: #1e40af;
    padding: 4px 6px;
    background: #eff6ff;
    border-left: 3px solid #3b82f6;
    border-radius: 3px;
  }
  .cb-signers { margin-top: 16px; display: flex; justify-content: space-between; font-size: 9px; padding: 12px; background: #f9fafb; border-radius: 6px; }
  .cb-signers div { text-align: center; width: 32%; }
  .cb-signers .label { font-weight: 700; margin-bottom: 30px; color: #374151; text-transform: uppercase; font-size: 8px; }
  .cb-signers .signature-line { border-bottom: 1px solid #9ca3af; margin-bottom: 4px; height: 24px; }
  @media print {
    @page { margin: 10mm 8mm; }
    .cb-container { padding: 8px 12px; }
    .cb-watermark { font-size: 96px; }
    .cb-summary-table tbody tr:hover, .cb-branch-table tbody tr:hover, .cb-tx-table tbody tr:hover {
      background: transparent;
    }
  }
</style>

{% if doc.reprint_count and doc.reprint_count > 0 %}
<div class="cb-watermark">REPRINT #{{ doc.reprint_count }}</div>
{% endif %}

<div class="cb-container">
  <div class="cb-header">
    <div class="cb-title">
      Cash / Bank Daily Report
      {% if doc.cash_account %}
        <span class="cb-type-badge cash">CASH LEDGER</span>
      {% elif doc.bank_account %}
        <span class="cb-type-badge bank">BANK TRANSACTION</span>
      {% endif %}
      {% if doc.reprint_count and doc.reprint_count > 0 %}
        <span class="cb-reprint-badge">REPRINT #{{ doc.reprint_count }}</span>
      {% endif %}
    </div>
    <div class="cb-subtitle">
      {{ frappe.utils.format_date(doc.report_date) }}
      {% if doc.branches %}
        · Branches: {{ doc.branches }}
      {% else %}
        · All Branches
      {% endif %}
      {% if doc.bank_account %}
        · Bank Account: {{ doc.bank_account }}
      {% elif doc.cash_account %}
        · Cash Account: {{ doc.cash_account }}
      {% endif %}
      {% if doc.reprint_count and doc.reprint_count > 0 %}
        · Reprint: {{ frappe.utils.format_datetime(doc.last_reprinted_at) }} by {{ doc.last_reprinted_by }}
      {% endif %}
    </div>
  </div>

  <table class="cb-summary-table">
    <thead>
      <tr>
        <th>{{ _("Opening Balance") }}</th>
        <th>{{ _("Inflow") }}</th>
        <th>{{ _("Outflow") }}</th>
        <th>{{ _("Closing Balance") }}</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="text-right">{{ frappe.utils.fmt_money(consolidated.get('opening_balance') or doc.opening_balance or 0) }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(consolidated.get('inflow') or doc.inflow or 0) }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(consolidated.get('outflow') or doc.outflow or 0) }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(consolidated.get('closing_balance') or doc.closing_balance or 0) }}</td>
      </tr>
    </tbody>
  </table>

  <table class="cb-branch-table">
    <thead>
      <tr>
        <th style="width:25%">{{ _("Branch") }}</th>
        <th style="width:18%" class="text-right">{{ _("Opening") }}</th>
        <th style="width:18%" class="text-right">{{ _("Inflow") }}</th>
        <th style="width:18%" class="text-right">{{ _("Outflow") }}</th>
        <th style="width:21%" class="text-right">{{ _("Closing") }}</th>
      </tr>
    </thead>
    <tbody>
      {% for br in branches %}
      <tr>
        <td>{{ br.get('branch') }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(br.get('opening_balance') or 0) }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(br.get('inflow') or 0) }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(br.get('outflow') or 0) }}</td>
        <td class="text-right">{{ frappe.utils.fmt_money(br.get('closing_balance') or 0) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {# Detail transaksi per cabang: diambil dari br.transactions yang sudah berisi Bank Transaction #}
  {% for br in branches %}
    {% set txs = br.get('transactions') or [] %}
    {% if txs %}
    <div class="cb-branch-section">
      <div class="cb-branch-heading">{{ _("Branch") }}: {{ br.get('branch') }}</div>
      <table class="cb-tx-table">
        <thead>
          <tr>
            <th style="width:10%">{{ _("Date") }}</th>
            <th style="width:16%">{{ _("Reference") }}</th>
            <th style="width:28%">{{ _("Description ER") }}</th>
            <th style="width:15%" class="text-right">{{ _("Deposit") }}</th>
            <th style="width:15%" class="text-right">{{ _("Withdrawal") }}</th>
            <th style="width:16%" class="text-right">{{ _("Balance") }}</th>
          </tr>
        </thead>
        <tbody>
          {% set running_balance = br.get('opening_balance') or 0 %}
          {% for tx in txs %}
          {% set deposit = tx.get('deposit') or 0 %}
          {% set withdrawal = tx.get('withdrawal') or 0 %}
          {% set running_balance = running_balance + deposit - withdrawal %}
          <tr>
            <td>{{ frappe.utils.format_date(tx.get('posting_date')) }}</td>
            <td style="font-size: 8px;">{{ tx.get('reference') }}</td>
            <td style="font-size: 8px;">{{ tx.get('er_description') or tx.get('description') or "-" }}</td>
            <td class="text-right" style="color: #16a34a; font-weight: 500;">{{ frappe.utils.fmt_money(deposit) if deposit > 0 else "-" }}</td>
            <td class="text-right" style="color: #dc2626; font-weight: 500;">{{ frappe.utils.fmt_money(withdrawal) if withdrawal > 0 else "-" }}</td>
            <td class="text-right" style="font-weight: 600;">{{ frappe.utils.fmt_money(running_balance) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  {% endfor %}

  {% if signers %}
  <div class="cb-signers">
    <div>
      <div class="label">{{ _("Prepared By") }}</div>
      <div class="signature-line"></div>
      <div style="font-weight: 600; color: #1f2937;">{{ signers.get('prepared_by') or "" }}</div>
    </div>
    <div>
      <div class="label">{{ _("Approved By") }}</div>
      <div class="signature-line"></div>
      <div style="font-weight: 600; color: #1f2937;">{{ signers.get('approved_by') or "" }}</div>
    </div>
    <div>
      <div class="label">{{ _("Acknowledged By") }}</div>
      <div class="signature-line"></div>
      <div style="font-weight: 600; color: #1f2937;">{{ signers.get('acknowledged_by') or "" }}</div>
    </div>
  </div>
  {% endif %}

  {% if doc.created_by_user or doc.submit_on %}
  <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #e5e5e5; font-size: 8px; color: #666;">
    {% if doc.created_by_user %}
    <div><strong>{{ _("Created By") }}:</strong> {{ doc.created_by_user }}</div>
    {% endif %}
    {% if doc.submit_on %}
    <div><strong>{{ _("Submit On") }}:</strong> {{ frappe.utils.format_datetime(doc.submit_on) }}</div>
    {% endif %}
  </div>
  {% endif %}
</div>
